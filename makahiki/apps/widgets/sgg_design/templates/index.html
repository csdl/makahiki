<div class="content-box">
    <div class="content-box-title">Smart Grid Game Designer</div>
    <div id="content" class="content-box-contents">
        <div class="row-fluid">
            <div class="span3">Drag the Categories to create columns. Then Drag 
            the Activities, Commitments, or Events to fill the Grid.
            
                <button class="btn btn-widget" onclick="saveSggLayout();">Save SGG</button>
            </div>
            <div class="span9">
                <div class="sgg-category-title">
                    <h5>Categories:</h5>
                    <div class="ssg-category-selections clearfix">
                        {% for category in view_objects.sgg_design.categories %}
                        <div id="{{category.slug}}"
                            class="sgg-category draggable">{{category}}</div>
                        {% endfor %}
                    </div>
                    <div class="sgg-dropzone clearfix">
                        <div id="category-dropzone"
                            class="sgg-category-dropzone clearfix">
                            <table>
                                <tr></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span3">
                <div class="sgg-action sgg-clear draggable" data-type="clear">erase</div>
                <div class="sgg-action sgg-filler draggable" data-type="filler">filler</div>
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#activities" data-toggle="tab">Activities</a>
                    </li>
                    <li class="">
                        <a href="#commitments" data-toggle="tab">Cmnts.</a>
                    </li>
                    <li class="">
                        <a href="#events" data-toggle="tab">Events</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="activities" class="sgg-action-selections tab-pane active" style="height: 600px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.activities %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-activity draggable">{{action.name}}</div>
                        {% endfor %}
                    </div>
                    <div id="commitments" class="sgg-action-selections tab-pane" style="height: 600px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.commitments %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-commitment draggable">{{action.name}}</div>
                        {% endfor %}
                    </div>
                    <div id="events" class="sgg-action-selections tab-pane" style="height: 600px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.events %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-event draggable">{{action.name}}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="span9">
                <div class="sgg-dropzone clearfix">
                    <div id="action-dropzone"
                        class="sgg-action-dropzone clearfix">
                        <table>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
	$(init);

	function init() {
		$('.draggable').draggable({
			cursor : 'move',
			helper : 'clone',
		});

		var t = $('#action-dropzone table');
		var c = $('#category-dropzone table tr')
		for ( var i = 1; i <= 10; i++) {
			$('<td><div class="sgg-category-slot"></div></td>').data(
					'priority', i).appendTo(c).droppable({
				accept : '.sgg-category',
				drop : handleCategoryDrop
			});
			var row = $('<tr></tr>').data('priority', i * 10).appendTo(t);
			for ( var j = 1; j <= 10; j++) {
				$('<td><div class="sgg-action-slot"></div></td>').data(
						'column-num', j).appendTo(row).droppable({
					accept : '.sgg-action',
					drop : handleActionDrop
				})
			}
		}
	}

	function handleCategoryDrop(event, ui) {
		var slotNumber = $(this).data('priority');
		var slug = ui.draggable.attr('id');
		var drop = $('<div id="' + slug + '" class="sgg-category draggable" ' +
				'data-priority="' + slotNumber + '" data-slug="' + slug + '">'  + ui.draggable.text() + '</div>');
		var html = $('<div />').append(drop.clone()).html();
		$(this).html(html);

	}

	function handleActionDrop(event, ui) {
	    var column = $(this).data('column-num');
	    var priority = $(this).parent().data('priority');
        var slug = ui.draggable.attr('id');
        var type = ui.draggable.data('type');
        if (type == "clear") {
        	$(this).html('<div class="sgg-action-slot"></div>');
        } else {
            $(this).html('<div id="' + slug + '" class="sgg-' + type + '-cell draggable" ' +
                   		   	'data-type="' + type + '">' + ui.draggable.text() + '</div>');
        }
	}

	function saveSggLayout() {
		var categories = $('#category-dropzone table tr');
		var children = categories.find("td div.sgg-category");
		for (var i = 0; i < children.length; i++) {
			var child = $(children[i]);
			console.log(child.data('slug') + "'s priority is " + child.data('priority'));
		}
	}
</script>