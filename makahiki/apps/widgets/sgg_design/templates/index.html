{% load sgg_design_tags %}

<div class="content-box">
    <div class="content-box-title">Smart Grid Game Designer</div>
    <div id="content" class="content-box-contents">
        <div class="row-fluid">
            <div class="span3">Drag the Categories to create columns. Then Drag 
            the Activities, Commitments, or Events to fill the Grid.
            
	            <form action="/sgg_design/update_smart_grid/" method="post">
    	        	{% csrf_token %}
					{{ view_objects.sgg_design.form.as_p }}
					<input class="btn btn-widget" type="submit" value="Save SGG" />
				</form>
            </div>
            <div class="span9">
                <div class="sgg-category-title">
                    <h5>Categories:</h5>
                    <div class="ssg-category-selections clearfix">
                        {% for category in view_objects.sgg_design.categories %}
                        <div id="{{category.slug}}"
                            class="sgg-category draggable">{{category}}</div>
                        {% endfor %}
                    </div>
                    <div class="sgg-dropzone clearfix">
                        <div id="category-dropzone"
                            class="sgg-category-dropzone clearfix">
                            <table>
                                <tr>
                                {% for i in 10|get_range %}
                                	<td><div class="sgg-category-slot" data-column={{ i|add:'1' }}></div></td>
                                {% endfor %}
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span3">
                <div class="sgg-action sgg-clear draggable" data-type="clear">erase</div>
                <div class="sgg-action sgg-filler draggable" data-type="filler">filler</div>
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#activities" data-toggle="tab">Activities</a>
                    </li>
                    <li class="">
                        <a href="#commitments" data-toggle="tab">Cmnts.</a>
                    </li>
                    <li class="">
                        <a href="#events" data-toggle="tab">Events</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="activities" class="sgg-action-selections tab-pane active" style="height: 470px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.activities %}
                        <div id="{{action.slug}}" data-type="{{action.type}}" data-instance="{{action}}"
                            class="sgg-action sgg-activity draggable"><a href="{% url action_details action.type action.slug %}" class="sgg-action">{{action.name}}</a></div>
                        {% endfor %}
                    </div>
                    <div id="commitments" class="sgg-action-selections tab-pane" style="height: 470px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.commitments %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-commitment draggable"><a href="{% url action_details action.type action.slug %}" class="sgg-action">{{action.name}}</a></div>
                        {% endfor %}
                    </div>
                    <div id="events" class="sgg-action-selections tab-pane" style="height: 470px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.events %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-event draggable"><a href="{% url action_details action.type action.slug %}" class="sgg-action">{{action.name}}</a></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="span9">
                <div class="sgg-dropzone clearfix">
                    <div id="action-dropzone"
                        class="sgg-action-dropzone clearfix">
                        <table>
                        {% for i in 10|get_range %}
							<tr>
							{% for j in 10|get_range %}
								<td><div class="sgg-action-slot" data-column="{{ j|add:'1' }}" data-row="{{ i|add:'1' }}"></div></td>
							{% endfor %}
							</tr>
                        {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="row-fluid">
        	<div class="span12">
				<div class="content-box">
    				<div id="action-title" class="content-box-title"></div>
    				<div class="content-box-contents">
        				<p/>
        				This <span class="action-type"></span> is worth 
        				<span class="action-points"></span> points.
        			</div>
        		</div>
        	</div>
        </div>
    </div>

</div>

<script type="text/javascript">
	$(init);

	function init() {
		$('.draggable').draggable({
			cursor : 'move',
			helper : 'clone',
		});

		$('.sgg-category-slot').droppable({
			accept : '.sgg-category',
			drop : handleCategoryDrop
		});
		
		$('.sgg-action-slot').droppable({
			accept : '.sgg-action',
			drop : handleActionDrop
		});
	}

	function handleCategoryDrop(event, ui) {
		var column = $(this).data('column');
		var slug = ui.draggable.attr('id');
		var drop = $('<div id="' + slug + '" class="sgg-category draggable" ' +
				'data-priority="' + column + '" data-slug="' + slug + '">'  + ui.draggable.text() + '</div>');
		var html = $('<div />').append(drop.clone()).html();
		for (var i = 1; i < 11; i++) {
			var row = $('#action-dropzone table tbody tr:nth-child('+ i +')');
			var cell = row.find('td:nth-child(' + column + ')');
			var outerDiv = cell.children('div');
//			div.data('category', slug);
			outerDiv.attr('data-category', slug);
			var innerDiv = outerDiv.children('div');
			innerDiv.attr('data-category', slug);
		}
		$(this).html(html);
		saveSggLayout();
	}

	function handleActionDrop(event, ui) {
	    var column = $(this).data('column');
	    var category = $(this).data('category');
	    var row = $(this).data('row');
        var slug = ui.draggable.attr('id');
        var type = ui.draggable.data('type');
        if (type == "clear") {
        	$(this).html('<div class="sgg-action-slot"></div>');
        } else {
            $(this).html('<div id="' + slug + '" class="sgg-action sgg-' + type + '-cell draggable" ' +
                   		   	'data-type="' + type + '" data-priority="' + row + '" data-column="' + 
                   		   	column + '" data-category="' + category + '">' + '<a href="/sgg_design/' + 
                   		   	type + '/' + slug + '/" class="sgg-action">' + ui.draggable.text()+ '</a></div>');
        }
        saveSggLayout();
        fillActionDetails(ui.draggable);
	}
	
	function fillActionDetails(action) {
		var title = $('#action-title');
		var name = action.text();
		var type = action.data('type');
		var instance = action.data('instance');
		title.html(type.charAt(0).toUpperCase() + type.slice(1) + ": " + name );
		var typespans = $('.action-type');
		typespans.html('{{instance.type}}');
	}

	function saveSggLayout() {
		var categories = $('#category-dropzone table tr');
		var children = categories.find("td div.sgg-category");
		var hidden_category = $('#id_category_updates');
		var hidden_action = $('#id_action_updates');
		var inner_str = '';
		for (var i = 0; i < children.length; i++) {
			var child = $(children[i]);
			var cat_str = '"'.concat(child.data('slug'),'", ', child.data('priority'));
			inner_str = inner_str.concat(cat_str, ', ');
		}
		var tmp = inner_str.substr(0, inner_str.length - 2);
		hidden_category.attr('value', ''.concat('[', tmp, ']'));
		var actions = $('#action-dropzone table');
		var droppedActions = actions.find("td div.sgg-action");
		inner_str = '';
		for (var j = 0; j < droppedActions.length; j++) {
			var action = $(droppedActions[j]);
			var act_slug = action.attr('id');
			var category = action.attr('data-category');
			var pri = action.attr('data-priority');
			var cat_str = '"'.concat(act_slug, '", "', category, '", ', pri);
			inner_str = inner_str.concat(cat_str, ', ');
		}
		tmp = inner_str.substr(0, inner_str.length - 2);
		hidden_action.attr('value', ''.concat('[', tmp, ']'));
	}
</script>