{% load sgg_design_tags %}

<div class="content-box">
	<div class="content-box-title">Smart Grid Game Designer</div>
	<div id="content" class="content-box-contents">
		<div class="row-fluid">
			<div class="span3">
				Drag the Categories to create columns. Then Drag the Activities,
				Commitments, or Events to fill the Grid.

				<form id="save-form" action="/sgg_design/update_smart_grid/" method="post">
					{% csrf_token %} {{ view_objects.sgg_design.form.as_p }} 
					<input class="btn btn-widget" onclick="saveFormSubmit();return false;" value="Save SGG" />
				</form>
			</div>
			<div class="span9">
				<div class="sgg-category-title">
					<h5>Categories:</h5>
					<div class="ssg-category-selections clearfix">
						{% for category in view_objects.sgg_design.categories %}
						<div id="{{category.slug}}" class="sgg-category draggable">{{category}}</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span3">
				<div class="sgg-action sgg-clear draggable" data-type="clear">erase</div>
				<div class="sgg-action sgg-filler draggable" data-type="filler">filler</div>
				<ul class="nav nav-tabs">
					<li class="active"><a href="#activities" data-toggle="tab">Activities</a>
					</li>
					<li class=""><a href="#commitments" data-toggle="tab">Cmnts.</a>
					</li>
					<li class=""><a href="#events" data-toggle="tab">Events</a></li>
				</ul>
				<div class="tab-content">
					<div id="activities" class="sgg-action-selections tab-pane active"
						style="height: 470px; overflow: scroll;">
						{% for action in view_objects.sgg_design.activities %}
						<div id="{{action.slug}}" data-slug="{{action.slug}}" data-type="{{action.type}}"
							data-instance="{{action}}"
							class="sgg-action sgg-activity draggable">
							<a href="{% url action_details action.type action.slug %}"
								class="sgg-action">{{action.name}}</a>
						</div>
						{% endfor %}
					</div>
					<div id="commitments" class="sgg-action-selections tab-pane"
						style="height: 470px; overflow: scroll;">
						{% for action in view_objects.sgg_design.commitments %}
						<div id="{{action.slug}}" data-slug="{{action.slug}}" data-type="{{action.type}}"
							class="sgg-action sgg-commitment draggable">
							<a href="{% url action_details action.type action.slug %}"
								class="sgg-action">{{action.name}}</a>
						</div>
						{% endfor %}
					</div>
					<div id="events" class="sgg-action-selections tab-pane"
						style="height: 470px; overflow: scroll;">
						{% for action in view_objects.sgg_design.events %}
						<div id="{{action.slug}}" data-slug="{{action.slug}}" data-type="{{action.type}}"
							class="sgg-action sgg-event draggable">
							<a href="{% url action_details action.type action.slug %}"
								class="sgg-action">{{action.name}}</a>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
			<div class="span9">
				<!-- Tabs for the levels -->
				<ul id="sgg-levels-tab" class="nav nav-tabs">
				{% for level in view_objects.sgg_design.levels %}
					{% if forloop.counter == 1 %}
					<li class="active">
					{% else %}
					<li class="">					
					{% endif %}
						<a class="level-unlocked" data-toggle="tab" style="padding-right: 6px; padding-left: 6px;" 
						   title="{{ level.name }} Actions"
						   href="#sgg-level-{{forloop.counter}}" rel="tooltip" >
						   {{ level.name }}
						</a></li>
				{% endfor %}
				</ul>
	        	<!-- Tab contents -->
        		<div id="sgg-grid" class="tab-content">
        		{% for level in view_objects.sgg_design.smart_grid %}
            		<div id="sgg-level-{{forloop.counter}}" 
           			{% if forloop.counter == 1 %}
						  class="tab-pane active"
            		{% else %}
            			  class="tab-pane"
					{% endif %}            		
					 data-level="{{level.name}}">
					{% include "sgg_grid.html" %}
					</div>
				{% endfor %}
				</div>
			</div>
		</div>
	</div>

</div>

<script type="text/javascript">
	$(init);

	function init() {
		$('.draggable').draggable({
			cursor : 'move',
			helper : 'clone',
		});

		$('.sgg-category-slot').droppable({
			accept : '.sgg-category',
			drop : handleCategoryDrop
		});
	    var saved = getCookie('sgg_save');
	    if (saved) {
	    	//console.log(saved);
	    	clearCategories();
	    	clearActions();
	    	loadSavedSGG(saved);
	    }
	}

	function handleCategoryDrop(event, ui) {
		var levelID = findLevelID(this);
		var actionDz = $('#' + levelID + ' .sgg-action-dropzone');
		var column = $(this).data('column');
		var slug = ui.draggable.attr('id');
		var drop = $('<div data-slug="' + slug + '" class="sgg-category-drop" ' +
				'data-priority="' + column + '">'
				+ ui.draggable.text() + '</div>');
		var html = $('<div />').append(drop.clone()).html();
		$(this).html(html);
		for ( var i = 1; i < 11; i++) {
			var row = $('#' + levelID + ' .sgg-action-dropzone table tbody tr:nth-child(' + i + ')');
			var tdCell = row.find('td:nth-child(' + column + ')');
			var outerDiv = tdCell.children('div');
			outerDiv.removeClass('disabled');
			// Activate the div for dropping.
			outerDiv.droppable({
				accept : '.sgg-action',
				drop : handleActionDrop
			});
			outerDiv.attr('data-category', slug);
			var innerDiv = outerDiv.children('div');
			innerDiv.attr('data-category', slug);
		}
		saveSggLayout();
	}

	function handleActionDrop(event, ui) {
		var column = $(this).data('column');
		var category = $(this).data('category');
		var row = $(this).data('row');
		var slug = ui.draggable.attr('id');
		var type = ui.draggable.data('type');
		if (type == "clear") {
			$(this).html('<div class="sgg-action-slot"></div>');
		} else {
			$(this)
					.html(
							'<div data-slug="' + slug + '" class="sgg-action sgg-' + type + '-cell draggable" ' +
                   		   	'data-type="' + type + '" data-priority="' + row + '" data-column="' + 
                   		   	column + '" data-category="' + category + '">'
									+ '<a href="/sgg_design/' + 
                   		   	type + '/' + slug + '/" class="sgg-action">'
									+ ui.draggable.text() + '</a></div>');
		}
		saveSggLayout();
	}

	function clearCategories() {
	    $('.sgg-category-slot').empty();
	    $('.sgg-action-slot').addClass("disabled");
	}
	
	function clearActions() {
	    $('.sgg-action-slot').empty();	
	}
	
	function saveSggLayout() {
		var levels = $('#sgg-grid .tab-pane');
		var hidden_category = $('#id_category_updates');
		hidden_category.attr('value', '');
		var hidden_action = $('#id_action_updates');
		hidden_action.attr('value', '');
		var cat_value = '';
		var act_value = '';
		levels.each(function () {
			cat_value = hidden_category.attr('value');
			var level = $(this).attr('data-level');
			var slug = $(this).attr('id');
			var levelStr = '"' + level + '"';
			var categories = $(this).find('#category-dropzone table tr');
			var children = categories.find("td div.sgg-category-drop");
			var inner_str =  '';
			for ( var i = 0; i < children.length; i++) {
				var child = $(children[i]);
				var cat_str = '"'.concat(child.data('slug'), '", ', child
						.data('priority'));
				inner_str = inner_str.concat(cat_str, ', ');
			}
			if (children.length > 0) {
				var tmp = inner_str.substr(0, inner_str.length - 2);
				var cat_list = levelStr.concat(', [', tmp, ']');
				cat_value = cat_value.concat('[' + cat_list + '], ');
				hidden_category.attr('value', cat_value);
			}

			act_value = hidden_action.attr('value');
			var actions = $(this).find('#action-dropzone table');
			var droppedActions = actions.find("td div.sgg-action");
			inner_str = '';
			for ( var j = 0; j < droppedActions.length; j++) {
				var action = $(droppedActions[j]);
				var act_slug = action.attr('data-slug');
				var category = action.attr('data-category');
				var pri = action.attr('data-priority');
				var act_str = '"'.concat(act_slug, '", "', category, '", ', pri);
				inner_str = inner_str.concat(act_str, ', ');
			}
			if (droppedActions.length > 0) {
				tmp = inner_str.substr(0, inner_str.length - 2);
				var act_list = levelStr.concat(', [' + tmp + ']');
				act_value = act_value.concat('[' + act_list + '], ');
				hidden_action.attr('value', act_value);
			}
		});
		cat_value = hidden_category.attr('value');
		cat_value = cat_value.substr(0, cat_value.length - 2);
		cat_value = ''.concat('[' + cat_value + ']');
		hidden_category.attr('value', cat_value);
		
		act_value = hidden_action.attr('value');
		act_value = act_value.substr(0, act_value.length - 2);
		act_value = ''.concat('[' + act_value + ']');
		hidden_action.attr('value', act_value);
		
		setCookie('sgg_save', cat_value + act_value);
	}

	function loadSavedSGG(savedData) {
		console.log(savedData);
		var s = jQuery.parseJSON(savedData);
		for (var i = 0; i < s.length; i++) {
			console.log(s[i]);
		}
	}
	
	function saveFormSubmit() {
		deleteCookie('sgg_save');
	    $('#save-form').submit();	
	}
	
	function hasClass(ele, cls) {
		return ele.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
	}

	function addClass(ele, cls) {
		if (!this.hasClass(ele, cls))
			ele.className += " " + cls;
	}

	function removeClass(ele, cls) {
		if (ele && hasClass(ele, cls)) {
			var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
			ele.className = ele.className.replace(reg, ' ');
		}
	}
	
	function findLevel(ele) {
		var p = ele.parentNode;
		
		while (p) {
			var level = $(p).attr('data-level');
			if (level) {
				return level;
			}
			p = p.parentNode;
		}
		return false;
	}
	
	function findLevelID(ele) {
		var p = ele.parentNode;
		
		while (p) {
			var level = $(p).attr('data-level');
			if (level) {
				return $(p).attr('id');
			}
			p = p.parentNode;
		}
		return false;
	}	
</script>