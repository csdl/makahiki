{% load sgg_design_tags %}

<div class="content-box">
    <div class="content-box-title">Smart Grid Game Designer</div>
    <div id="content" class="content-box-contents">
        <div class="row-fluid">
            <div class="span3">Drag the Categories to create columns. Then Drag 
            the Activities, Commitments, or Events to fill the Grid.
            
                <button class="btn btn-widget" onclick="saveSggLayout();">Save SGG</button>
            </div>
            <div class="span9">
                <div class="sgg-category-title">
                    <h5>Categories:</h5>
                    <div class="ssg-category-selections clearfix">
                        {% for category in view_objects.sgg_design.categories %}
                        <div id="{{category.slug}}"
                            class="sgg-category draggable">{{category}}</div>
                        {% endfor %}
                    </div>
                    <div class="sgg-dropzone clearfix">
                        <div id="category-dropzone"
                            class="sgg-category-dropzone clearfix">
                            <table>
                                <tr>
                                {% for i in 10|get_range %}
                                	<td><div class="sgg-category-slot" data-column={{ i|add:'1' }}></div></td>
                                {% endfor %}
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span3">
                <div class="sgg-action sgg-clear draggable" data-type="clear">erase</div>
                <div class="sgg-action sgg-filler draggable" data-type="filler">filler</div>
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#activities" data-toggle="tab">Activities</a>
                    </li>
                    <li class="">
                        <a href="#commitments" data-toggle="tab">Cmnts.</a>
                    </li>
                    <li class="">
                        <a href="#events" data-toggle="tab">Events</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div id="activities" class="sgg-action-selections tab-pane active" style="height: 600px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.activities %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-activity draggable"><a href="{% url action_details action.type action.slug %}" class="sgg-action">{{action.name}}</a></div>
                        {% endfor %}
                    </div>
                    <div id="commitments" class="sgg-action-selections tab-pane" style="height: 600px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.commitments %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-commitment draggable"><a href="{% url action_details action.type action.slug %}" class="sgg-action">{{action.name}}</a></div>
                        {% endfor %}
                    </div>
                    <div id="events" class="sgg-action-selections tab-pane" style="height: 600px; overflow: scroll;">
                        {% for action in view_objects.sgg_design.events %}
                        <div id="{{action.slug}}" data-type="{{action.type}}"
                            class="sgg-action sgg-event draggable"><a href="{% url action_details action.type action.slug %}" class="sgg-action">{{action.name}}</a></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="span9">
                <div class="sgg-dropzone clearfix">
                    <div id="action-dropzone"
                        class="sgg-action-dropzone clearfix">
                        <table>
                        {% for i in 10|get_range %}
							<tr>
							{% for j in 10|get_range %}
								<td><div class="sgg-action-slot" data-column="{{ j|add:'1' }}" data-row="{{ i|add:'1' }}"></div></td>
							{% endfor %}
							</tr>
                        {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script type="text/javascript">
	$(init);

	function init() {
		$('.draggable').draggable({
			cursor : 'move',
			helper : 'clone',
		});

		$('.sgg-category-slot').droppable({
			accept : '.sgg-category',
			drop : handleCategoryDrop
		});
		
		$('.sgg-action-slot').droppable({
			accept : '.sgg-action',
			drop : handleActionDrop
		});
	}

	function handleCategoryDrop(event, ui) {
		var column = $(this).data('column');
		var slug = ui.draggable.attr('id');
		var drop = $('<div id="' + slug + '" class="sgg-category draggable" ' +
				'data-priority="' + (column + 1) + '" data-slug="' + slug + '">'  + ui.draggable.text() + '</div>');
		var html = $('<div />').append(drop.clone()).html();
		for (var i = 1; i < 11; i++) {
			var row = $('#action-dropzone table tbody tr:nth-child('+ i +')');
			var cell = row.find('td:nth-child(' + column + ')');
			var outerDiv = cell.children('div');
//			div.data('category', slug);
			outerDiv.attr('data-category', slug);
			var innerDiv = outerDiv.children('div');
			innerDiv.attr('data-category', slug);
		}
		$(this).html(html);

	}

	function handleActionDrop(event, ui) {
	    var column = $(this).data('column');
	    var category = $(this).data('category');
	    var row = $(this).data('row');
        var slug = ui.draggable.attr('id');
        var type = ui.draggable.data('type');
        if (type == "clear") {
        	$(this).html('<div class="sgg-action-slot"></div>');
        } else {
            $(this).html('<div id="' + slug + '" class="sgg-action sgg-' + type + '-cell draggable" ' +
                   		   	'data-type="' + type + '" data-priority="' + row + '" data-column="' + 
                   		   	column + '" data-category="' + category + '">' + '<a href="/sgg_design/' + 
                   		   	type + '/' + slug + '/" class="sgg-action">' + ui.draggable.text()+ '</a></div>');
        }
	}

	function saveSggLayout() {
		var categories = $('#category-dropzone table tr');
		var children = categories.find("td div.sgg-category");
		for (var i = 0; i < children.length; i++) {
			var child = $(children[i]);
			console.log(child.data('slug') + "'s priority is " + child.data('priority'));
		}
		var actions = $('#action-dropzone table');
		var droppedActions = actions.find("td div.sgg-action");
//		var first = $(droppedActions[0]);
//		console.log("Found " + droppedActions.length + " actions." + first.html());
		for (var j = 0; j < droppedActions.length; j++) {
			var action = $(droppedActions[j]);
			console.log(action.attr('id') + "'s priority is " + action.data('priority') + " category is " + action.data('category'));
		}
	}
</script>