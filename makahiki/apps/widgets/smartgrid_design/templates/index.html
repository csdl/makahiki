{% load sgg_design_tags %}

<div class="content-box">
	<div class="content-box-title">Smart Grid Game Designer</div>
	<div id="content" class="content-box-contents">
		<div class="row-fluid">
			<div class="span3">
				Drag the Categories to create columns. Then Drag the Activities,
				Commitments, or Events to fill the Grid. Use the palette to temporarily
				store Smart Grid Actions.
				<div class="sgg-palette palette-dropzone">Palette</div>
			</div>
			<div class="span9">
				<div class="makahiki-box">
					<div class="sgg-category-title">
						<h5>Categories:</h5>
					</div>
					<div class="content-box-contents">
						<a href="/challenge_admin/smartgrid/category/">
							<div class="btn btn-widget">Edit Categories</div></a>
						Drag the category to the top row of the grid below. You cannot have the same category twice in the same level.
					</div>
					<div class="ssg-category-selections clearfix">
						{% for category in view_objects.smartgrid_design.categories %}
						<div class="sgg-category draggable" data-pk="{{category.pk}}" data-slug="{{category.slug}}">
							<a class="sgg-category" href="/challenge_admin/smartgrid/category/{{category.pk}}/">{{category}}</a>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span3">
				<div class="row-fluid">
					<div class="span4">
						<div class="sgg-action sgg-filler draggable" data-type="filler">filler</div>
					</div>
					<div class="span5">
						<div class="sgg-trash trash-dropzone"></div>
					</div>
				</div>
				<div>
				<ul class="nav nav-tabs">
					<li class="active"><a href="#activities" data-toggle="tab">Activities</a></li>
					<li class=""><a href="#commitments" data-toggle="tab">Cmnts.</a></li>
					<li class=""><a href="#events" data-toggle="tab">Events</a></li>
				</ul>
				</div>
				<div class="tab-content">
					<div id="activities" class="sgg-action-selections tab-pane active"
						style="height: 470px; overflow: scroll;">
						{% for action in view_objects.smartgrid_design.activities %}		
						<div id="{{action.slug}}" data-slug="{{action.slug}}" data-type="{{action.type}}" data-pk="{{action.pk}}"
							data-instance="{{action}}" 
							data-unlock="{{action.unlock_condition}}"
							class="sgg-action sgg-activity library-draggable {% if action.slug in view_objects.smartgrid_design.smart_grid_actions %}hidden{% endif %}">
							<a href="/admin/smartgrid/{{action.type}}/{{action.pk}}/"
								class="sgg-action">{{action.name}}</a>
						</div>
						{% endfor %}
					</div>
					<div id="commitments" class="sgg-action-selections tab-pane"
						style="height: 470px; overflow: scroll;">
						{% for action in view_objects.smartgrid_design.commitments %}
						<div id="{{action.slug}}" data-slug="{{action.slug}}" data-type="{{action.type}}" data-pk="{{action.pk}}"
							data-instance="{{action}}" 
							class="sgg-action sgg-commitment library-draggable {% if action.slug in view_objects.smartgrid_design.smart_grid_actions %}hidden{% endif %}">
							<a href="/admin/smartgrid/{{action.type}}/{{action.pk}}/"
								class="sgg-action">{{action.name}}</a>
						</div>
						{% endfor %}
					</div>
					<div id="events" class="sgg-action-selections tab-pane"
						style="height: 470px; overflow: scroll;">
						{% for action in view_objects.smartgrid_design.events %}
						<div id="{{action.slug}}" data-slug="{{action.slug}}" data-type="{{action.type}}" data-pk="{{action.pk}}"
							data-instance="{{action}}" 
							class="sgg-action sgg-event library-draggable {% if action.slug in view_objects.smartgrid_design.smart_grid_actions %}hidden{% endif %}">
							<a href="/admin/smartgrid/{{action.type}}/{{action.pk}}/"
								class="sgg-action">{{action.name}}</a>
						</div>
						{% endfor %}
					</div>
				</div>
			</div>
			<div class="span9">
				<div class="makahiki-box">
					<div class="content-box-contents">
						<a href="/admin/smartgrid/level/">
							<div class="btn btn-widget">Edit Levels</div></a>
					</div>
					<!-- Tabs for the levels -->
					<ul id="sgg-levels-tab" class="nav nav-tabs">
					{% for level in view_objects.smartgrid_design.levels %}
						{% if forloop.counter == 1 %}
						<li class="active">
						{% else %}
						<li class="">					
						{% endif %}
							<a class="level-unlocked" data-toggle="tab" style="padding-right: 6px; padding-left: 6px;" 
							   title="{{ level.name }} Actions"
							   href="#sgg-level-{{forloop.counter}}" rel="tooltip" >
							   {{ level.name }}
							</a></li>
					{% endfor %}
					</ul>
	    	    	<!-- Tab contents -->
        			<div id="sgg-grid" class="tab-content">
        			{% for level in view_objects.smartgrid_design.smart_grid %}
            			<div id="sgg-level-{{forloop.counter}}" 
	           			{% if forloop.counter == 1 %}
							  class="tab-pane active"
        	    		{% else %}
            				  class="tab-pane"
						{% endif %}            		
							  data-level="{{level.name}}"
							  data-levelslug="{{level.slug}}">
						{% include "sgg_grid.html" %}
						</div>
					{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<script type="text/javascript">
	$(init);

	var numFiller = {{view_objects.smartgrid_design.fillers|length}};
		
	// See sggDesigner.js for most of the functionality.
	function init() {
		$('.draggable').draggable({
			cursor : 'move',
			helper : 'clone'
		})
		$('.grid-draggable').draggable({
			cursor : 'move',
			helper : 'original',
			revert : function(dropObj) {
				console.log("revert for grid draggable");
				// if false then no drop object
				if (dropObj == false) {
					// revert the grid-draggable
					return true;
				} else {
					var answer = confirm('Remove this item from the Smart Grid?');
					if (answer) {
						var type = $(dropObj).attr('class');
						var first = type.split(" ")[0];
						if (first == 'sgg-palette') {
							handlePaletteDrop($(this));
						} else {
							handleTrashDrop($(this));
						}
						return false;
					}
					return !answer;
				}
			},
		});
		$('.library-draggable').draggable({
			cursor : 'move',
			start : handleLibraryStartDrag,
			helper : 'clone',
			revert : 'invalid',
		})
		$('.sgg-category-slot').droppable({
			accept : '.sgg-category',
			drop : handleCategoryDrop
		});
		$('.sgg-action-slot').droppable({
			accept : '.sgg-action',
			drop : handleActionDrop
		});
		$('.palette-dropzone').droppable({
			accept : '.sgg-action',
//			drop : handlePaletteDrop
		})
		$('.trash-dropzone').droppable({
//			drop : handleTrashDrop
		})
	    var saved = getCookie('sgg_save');
	    if (saved) {
	    	console.log('Have sgg_save cookie');
	    	console.log(">" + saved + "<");
	    	clearCategories();
	    	clearActions();
	    	loadSavedSGG(saved);
	    }
	}

	function clearCategories() {
	    $('.sgg-category-slot').empty();
	    $('.sgg-action-slot').addClass("disabled");
	}
	
	function clearActions() {
	    $('.sgg-action-slot').empty();	
	}
	
	function saveFormSubmit() {
		deleteCookie('sgg_save');
	    $('#save-form').submit();	
	}
	
	function hasClass(ele, cls) {
		return ele.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));
	}

	function addClass(ele, cls) {
		if (!this.hasClass(ele, cls))
			ele.className += " " + cls;
	}

	function removeClass(ele, cls) {
		if (ele && hasClass(ele, cls)) {
			var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');
			ele.className = ele.className.replace(reg, ' ');
		}
	}
	
	function handleLibraryStartDrag(event, ui) {
		$(this).addClass('hidden');
	}
	
</script>